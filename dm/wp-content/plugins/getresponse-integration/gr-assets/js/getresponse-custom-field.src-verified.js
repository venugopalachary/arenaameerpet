/*
 * This module hooks into the newOrder to add the customers
 * @author   Krzysztof Platta <k.platta@implix.com>
 * @copyright  GetResponse
 * @license http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
 (function(e){var h=Object.create||function(a){function b(){}b.prototype=a;b.prototype.constructor=b;return new b},m=function(){var a=document.getElementsByTagName("head")[0],b=document.createElement("style"),c;b.type="text/css";a.appendChild(b);c=b.sheet||b.styleSheet;return{addRules:function(a){for(var b in a)a.hasOwnProperty(b)&&(c.insertRule?c.insertRule(b+" {"+a[b]+"}",0):c.addRule&&c.addRule(b,a[b],0))}}}(),k,l;l={$wrapper:void 0,init:function(a){var b=this;this.$wrapper=e(a);this.$wrapper.find("[data-define]").each(function(){b[this.getAttribute("data-define")]=
this});return this},insert:function(a,b){switch(b||"beforeEnd"){case "afterBegin":this.$wrapper.prependTo(a);break;case "beforeBegin":this.$wrapper.insertBefore(a);break;case "afterEnd":this.$wrapper.insertAfter(a);break;default:this.$wrapper.appendTo(a)}return this},remove:function(){this.$wrapper.detach();return this}};k={selectOb:void 0,$container:void 0,optionData:void 0,count:0,disabled:0,used:0,fullselectActive:!1,init:function(a,b){var c;this.selectOb=a;c=this.build();this.fullselectActive=
b||!1;this.fullselect(c);this.setLimits();this.$container.insertBefore(a);a.parentNode.removeChild(a)},build:function(){var a=e("<ul></ul>"),b={},c=this.selectOb.options,d=c.length,f=[],g;this.count=d;this.$container=a;this.optionData=b;for(g=0;g<d;g+=1)a=c[g],b[a.value]={disabled:!!a.disabled,value:a.value,inputvalue:a.getAttribute('data-inputvalue')||a.value,text:a.innerHTML,used:!1};for(g=0;g<d;g+=1)if(a=c[g],a.selected||a.disabled)this.addItem(b[a.value]),f.push(b[a.value].template.select);return f},addItem:function(a){var b=this.$container,c=this.optionData,
d=h(l).init('<li><ul><li><select name="" data-define="select"></select></li><li><input name="" type="text" value="" data-define="input"/></li><li><a href="#" class="button small green" data-define="add">+</a><a href="#" class="button small red" data-define="sub">-</a></li></ul></li>'),f=this,g=this.selectOb;e.each(c,function(){var b=new Option(this.text,this.value);this.used||(d.select.add(b),this===a&&(b.selected=!0,a.disabled&&(b.disabled=!0),this.used=!0,this.template=d,d.select.optionDataItem=
this,f.narrowDown(b.value)))});this.used+=1;a.disabled&&(this.disabled+=1,d.select.disabled=!0,d.input.disabled=!0,d.$wrapper.addClass("disabledFields"));d.input.value=a.inputvalue;d.input.name=this.selectOb.name+"["+a.value+"]";e(d.select).bind({change:function(){var b=this.options[this.selectedIndex].value;f.narrowUp(a);a.used=!1;a.template=void 0;a=c[b];a.used=!0;a.template=d;d.select.optionDataItem=a;f.narrowDown(b);d.input.name=g.name+"["+b+"]";d.input.value=a.inputvalue}});e(d.sub).bind({click:function(b){b.stopPropagation();
b.preventDefault();f.narrowUp(a);a.used=!1;a.template=void 0;d.remove();f.used-=1;f.setLimits()}});e(d.add).bind({click:function(a){a.stopPropagation();a.preventDefault();e.each(c,function(){if(!this.used)return f.addItem(this),f.fullselect(this.template.select),!1});f.setLimits()}});d.insert(b)},narrowDown:function(a){var b=[];e.each(this.optionData,function(){var c;this.template&&(c=this.template.select,e.each(c.options,function(){if(this.value===a&&!this.selected)return c.remove(this.index),b.push(c),
!1}))});this.rebuildList(b)},narrowUp:function(a){var b=[];e.each(this.optionData,function(){var c;this.template&&this!==a&&(c=new Option(a.text,a.value),this.template.select.add(c),b.push(this.template.select))});this.rebuildList(b)},fullselect:function(a){this.fullselectActive&&e(a).fullSelectLc({mode:!1,name:""})},rebuildList:function(a){this.fullselectActive&&e(a).trigger("rebuildList")},setLimits:function(){this.$container.removeClass("maxLines minLines");this.used>=this.count&&this.$container.addClass("maxLines");
this.used<=this.disabled&&this.$container.addClass("minLines")}};m.addRules({'.maxLines [data-define="add"]':"display: none !important;",'.minLines [data-define="sub"], .disabledFields [data-define="sub"]':"display: none !important;",'.disabledFields li [data-define="add"]':'display: none !important;','.disabledFields:last-child [data-define="add"]': 'display:block !important;'});e.fn.selectNarrowDown=function(){this.each(function(){h(k).init(this)});return this};e.fn.fullSelectNarrowDown=function(){this.each(function(){h(k).init(this,!0)});return this}})(jQuery);